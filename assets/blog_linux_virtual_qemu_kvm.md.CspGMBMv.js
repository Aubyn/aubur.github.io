import{_ as i,c as a,a0 as n,o as h}from"./chunks/framework.D9MR4Zbk.js";const g=JSON.parse('{"title":"QEMU-KVM 虚拟化","description":"","frontmatter":{},"headers":[],"relativePath":"blog/linux/virtual_qemu_kvm.md","filePath":"blog/linux/virtual_qemu_kvm.md"}'),l={name:"blog/linux/virtual_qemu_kvm.md"};function p(k,s,t,e,r,F){return h(),a("div",null,s[0]||(s[0]=[n(`<h1 id="qemu-kvm-虚拟化" tabindex="-1">QEMU-KVM 虚拟化 <a class="header-anchor" href="#qemu-kvm-虚拟化" aria-label="Permalink to &quot;QEMU-KVM 虚拟化&quot;">​</a></h1><h2 id="why" tabindex="-1">why <a class="header-anchor" href="#why" aria-label="Permalink to &quot;why&quot;">​</a></h2><p>使用 Windows 或 Linux 的过程中，经常可能遇到系统突然崩溃的情况，数据丢失无法复原，同时无法继续工作。要么排查解决问题，要么重装系统消除问题，要么重新换一台电脑，修复非常漫长、被动。</p><p>但凡涉及到重装或者换电脑，往往就需要一系列的工作环境恢复：配置电脑网络、安装常用软件并登录等等。时间非常久，导致我们的工作被拖延。</p><p>解决问题的一个方案，便是使用虚拟机。将我们所有的工作相关内容都转移到虚拟机系统中，定期生成快照，定期将快照文件转存。这样当我们虚拟机系统突然挂掉的时候，能快速地恢复到上一次快照的情况，同时无需再处理各种工作环境恢复的事情，增加了我们工作环境的可靠性。当我们宿主系统挂掉的时候，我们也可以在另一台电脑上导入快照并启动，同样快速恢复工作。</p><h3 id="○-概念" tabindex="-1">○ 概念 <a class="header-anchor" href="#○-概念" aria-label="Permalink to &quot;○ 概念&quot;">​</a></h3><p>kvm：虚拟化技术，底层实现。提供 cpu 和内存的虚拟化模拟，性能极高。</p><p>qemu：虚拟器，虚拟机硬件环境模拟（硬盘、网络等）。提供外围设备模拟，io 性能较高。</p><p>virtio：虚拟机系统硬件驱动，实现和虚拟器实现高性能设备交互。其中 virtio-win 适用于 windows，安装过程中需要在 bus type 中设置，使其能读取到安装介质。</p><p>qxl ：windows 图形驱动，可实现调整界面分辨率</p><p>libvirt：虚拟机系统管理工具</p><p>spice：⌛</p><p>rdp客户端：⌛</p><h2 id="how" tabindex="-1">how <a class="header-anchor" href="#how" aria-label="Permalink to &quot;how&quot;">​</a></h2><p>虚拟机方案比较多。如果宿主系统是 Windows，虚拟化引擎选择 Hyper-V，虚拟系统可以选择 WSL、VirtualBox、VMWare 管理。</p><p>如果宿主系统是 Linux，虚拟化引擎选择内核级 KVM，相比 Hyper-V，具有更高的 io 性能，同时虚拟机系统能直通 USB（便于 USB 加密的网银）。</p><p>本文选用了 KVM 方式来实现虚拟化，探索虚拟机带来的可靠性。</p><p>kvm 虚拟系统管理方式：</p><ul><li>通过 virt-manager 导入旧配置，仍然需要一直点点点，麻烦</li><li>通过 qemu-kvm 命令启动则可以通过旧脚本一键启动</li></ul><h2 id="what-arch-宿主机" tabindex="-1">what - Arch 宿主机 <a class="header-anchor" href="#what-arch-宿主机" aria-label="Permalink to &quot;what - Arch 宿主机&quot;">​</a></h2><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 检查 CPU 虚拟化支持</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">grep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -E</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;svm|vmx&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /proc/cpuinfo</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">LC_ALL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">C.UTF-8</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> lscpu</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Virtualization</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 检查系统内核是否加载了 KVM 模块</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lsmod</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kvm</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">paru</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">paru</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -S</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> archlinux-keyring</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">paru</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -S</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> qemu</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> libvirt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ovmf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> virt-manager</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dnsmasq</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bridge-utils</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> openbsd-netcat</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> enable</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --now</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> libvirtd.service</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vim</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/libvirt/libvirtd.conf</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 添加用户到组，拥有虚拟机使用权限</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> usermod</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -aG</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> libvirt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">whoami</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> usermod</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -aG</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kvm</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">whoami</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 创建虚拟系统文件</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> qemu-img</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> qcow2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> debian_12.7.qcow2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 80G</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 安装虚拟系统</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> qemu-system-x86_64</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -enable-kvm</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-m </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">16G</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -smp</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-hda </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">./debian_12.7.qcow2</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-cdrom </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">./debian-12.7.0-amd64-DVD-1.iso</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-boot </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">d</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 启动虚拟系统</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 非图形界面，vga 需省略</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> qemu-system-x86_64</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -enable-kvm</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-hda </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">./debian_12.7.qcow2</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-cpu </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">host</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> size=16G</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -smp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cpus=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-vga </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">qxl</span></span></code></pre></div><h2 id="参考" tabindex="-1">参考 <a class="header-anchor" href="#参考" aria-label="Permalink to &quot;参考&quot;">​</a></h2><ul><li><a href="https://wiki.archlinux.org/title/QEMU" target="_blank" rel="noreferrer">QEMU</a>，非常详细，优先参考。虚拟机性能优化、virtio 驱动、spice 远程连接</li><li><a href="https://www.feiyunote.cn/posts/Arch%E5%AE%89%E8%A3%85KVM/" target="_blank" rel="noreferrer">Arch安装KVM | SkyFish小小站</a></li><li><a href="https://github.com/yifengyou/learn-kvm" target="_blank" rel="noreferrer">QEMU KVM学习笔记</a></li><li><a href="https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/" target="_blank" rel="noreferrer">virtio-win.iso</a></li></ul>`,23)]))}const o=i(l,[["render",p]]);export{g as __pageData,o as default};
